# Code Locations for Attack Speed & Damage Mechanics

This document maps the exact locations in the IL2CPP dump where attack speed and damage mechanics are defined.

## File Location
- **Main dump file**: `C:\apktool\il2cpp-output\dump.cs` (60 MB, 1.2 million lines)
- **Generated by**: Il2CppDumper v6.7.46
- **Source**: `libil2cpp.so` + `global-metadata.dat` from the game APK

## Key Classes and Structures

### 1. WeaponInfo Class
**Location**: Line 1050834
**Purpose**: Stores base weapon configuration including attack timings

```csharp
public class WeaponInfo : IGameConfigData<ItemId> {
    [MetaMember(3, 0)]
    public F64 AttackRange { get; set; }      // Line 1050860
    
    [MetaMember(4, 0)]
    public F64 WindupTime { get; set; }       // Line 1050862 - BASE windup time
    
    [MetaMember(5, 0)]
    public F64 AttackDuration { get; set; }   // Line 1050864 - BASE attack duration
    
    [MetaMember(6, 0)]
    public bool IsRanged { get; set; }
    
    [MetaMember(7, 0)]
    public bool IsAiming { get; set; }
    
    [MetaMember(8, 0)]
    public int ProjectileId { get; set; }
}
```

### 2. UnitEntity Struct
**Location**: Line 1057596-1057599
**Purpose**: Runtime entity data for units in combat

```csharp
[MetaMember(4, 0)]
public FD6 AttackTimer; // 0x50 - Countdown timer for next attack

[MetaMember(5, 0)]
public FD6 AttackDuration; // 0x58 - ACTUAL attack duration (after AttackSpeedMulti applied)

[MetaMember(6, 0)]
public FD6 WindUpDuration; // 0x68 - ACTUAL windup duration (after AttackSpeedMulti applied)
```

### 3. CombatStats Struct
**Location**: Referenced in line 472605 (member names constant)
**Purpose**: Contains all combat statistics including attack speed multiplier

```csharp
public struct CombatStats {
    public CombatStatFixedD6 HpMax;
    public CombatStatFixedD6 Dmg;
    public CombatStatFixedD6 CriticalChance;
    public CombatStatFixedD6 CriticalMulti;
    public CombatStatFixedD6 AttackSpeedMulti;  // ⭐ THE KEY STAT
    public CombatStatFixedD6 BlockChance;
    public CombatStatFixedD6 DodgeChance;
    public CombatStatFixedD6 HealthRegen;
    public CombatStatFixedD6 LifeSteal;
    public CombatStatFixedD6 DoubleDamageChance;
    public AttackType AttackType;
}
```

### 4. AttacksSystem Class
**Location**: Line 1057705
**Purpose**: Main combat system that processes attacks

```csharp
public class AttacksSystem {
    private RandomPCG _random; // Line 1057709
    
    // Main combat loop - called every frame
    // Line 1057720
    public void Execute(Entities entities, F64 dt, List<CombatDmg> damageInstances, 
                       List<BasicEntity> newEntities, List<BasicEntity> destroyedEntities,
                       IMetaLogger logger, SharedGameConfig config) { }
    
    // Handles unit attack timing
    // Line 1057735
    private void HandleUnits(Entities entities, F64 dt, List<CombatDmg> damageInstances, 
                            List<BasicEntity> newEntities, List<BasicEntity> destroyedEntities,
                            IMetaLogger logger, SharedGameConfig config) { }
    
    // Calculates damage with all modifiers (crit, dodge, block, etc.)
    // Line 1057726
    private CombatDmg GetDamage(UnitEntity target, CombatStats attackStats) { }
    
    // Applies calculated damage to target
    // Line 1057723
    private void ApplyDmg(UnitEntity target, UnitEntity attacker, CombatStats attackStats, 
                         List<CombatDmg> damageInstances, List<BasicEntity> destroyedEntities) { }
    
    // Executes the attack action
    // Line 1057744
    private void ExecuteAttack(Entities entities, List<CombatDmg> damageInstances, 
                              List<BasicEntity> newEntities, List<BasicEntity> destroyedEntities,
                              UnitEntity unit) { }
}
```

### 5. Attack Speed Event System
**Location**: Lines 688697-688724
**Purpose**: Event-driven system for attack speed changes

```csharp
// Entity extension methods for attack speed
public void AddAttackSpeed(float newValue) { }           // Line 688697
public void ReplaceAttackSpeed(float newValue) { }       // Line 688700
public void RemoveAttackSpeed() { }                      // Line 688703

// Listener management
public void AddAttackSpeedListener(List<IAttackSpeedListener> newValue) { }    // Line 688712
public void ReplaceAttackSpeedListener(List<IAttackSpeedListener> newValue) { } // Line 688715
public void RemoveAttackSpeedListener() { }                                     // Line 688718
public void AddAttackSpeedListener(IAttackSpeedListener value) { }             // Line 688721
public void RemoveAttackSpeedListener(IAttackSpeedListener value, bool removeComponentWhenEmpty = True) { } // Line 688724
```

**Listener Interface** (Line 700438):
```csharp
public interface IAttackSpeedListener {
    void OnAttackSpeed(GameEntity entity, float value);
}
```

### 6. CombatDmg Struct
**Location**: Referenced throughout AttacksSystem
**Purpose**: Stores damage calculation results

```csharp
public struct CombatDmg {
    public FD6 Damage;      // Final damage amount
    public bool Dodged;     // Was attack dodged?
    public bool Blocked;    // Was attack blocked?
    public bool Critical;   // Was it a critical hit?
    public FD6 Heal;        // Healing amount (life steal)
}
```

## The Attack Speed Formula

### Where It's Applied
The formula `Effective Time = Base Time / AttackSpeedMulti` is applied in the `HandleUnits` method (line 1057735), but the actual implementation is compiled to native ARM code in `libil2cpp.so`.

### Data Flow
1. **Configuration** (WeaponInfo):
   - `WindupTime` = 1.0 seconds (example)
   - `AttackDuration` = 1.5 seconds (example)

2. **Runtime Stats** (CombatStats):
   - `AttackSpeedMulti` = 1.5 (50% faster)

3. **Applied to Entity** (UnitEntity):
   - `WindUpDuration` = 1.0 / 1.5 = 0.67 seconds
   - `AttackDuration` = 1.5 / 1.5 = 1.0 seconds
   - `AttackTimer` = counts down from AttackDuration

4. **Update Loop** (AttacksSystem.HandleUnits):
   - Each frame: `AttackTimer -= deltaTime`
   - When `AttackTimer <= 0`: Execute attack
   - Reset: `AttackTimer = AttackDuration`

## Important Notes

### IL2CPP Compilation
- The game uses **IL2CPP** (Intermediate Language to C++) compilation
- C# code is converted to C++, then compiled to native ARM code
- The dump shows **structure and signatures** but not the actual logic
- Method bodies appear as empty stubs: `{ }`
- The actual division and calculation happens in the compiled `libil2cpp.so` binary

### Fixed-Point Math
The game uses custom fixed-point types for deterministic calculations:
- `F64` - 64-bit fixed-point number
- `FD6` - Fixed-point with 6 decimal places
- This ensures identical results on client and server (no floating-point errors)

### Entity Component System (ECS)
The game uses an ECS architecture:
- **Entities**: Game objects (units, projectiles, etc.)
- **Components**: Data (AttackSpeed, CombatStats, etc.)
- **Systems**: Logic (AttacksSystem, SkillSystem, etc.)

## How to Search the Dump

To find specific code in the dump.cs file:

```powershell
# Search for a class or struct
Select-String -Path "C:\apktool\il2cpp-output\dump.cs" -Pattern "class AttacksSystem"

# Search for a method
Select-String -Path "C:\apktool\il2cpp-output\dump.cs" -Pattern "void HandleUnits"

# Search for a field or property
Select-String -Path "C:\apktool\il2cpp-output\dump.cs" -Pattern "AttackSpeedMulti"

# Search with context (3 lines before and after)
Select-String -Path "C:\apktool\il2cpp-output\dump.cs" -Pattern "AttackTimer" -Context 3,3
```

## Related Files

- **Main APK**: `C:\apktool\main-apk-out\` - Game resources, assets, configs
- **Native Libraries**: `C:\apktool\config-armeabi-out\lib\armeabi-v7a\` - Contains `libil2cpp.so` and `libunity.so`
- **Game Config**: `C:\apktool\main-apk-out\assets\SharedGameConfig.mpa` - Binary configuration file with all game data
- **IL2CPP Metadata**: `C:\apktool\main-apk-out\assets\bin\Data\Managed\Metadata\global-metadata.dat` - Type information used by Il2CppDumper

## Summary

The attack speed formula is **definitively** `Effective Time = Base Time / AttackSpeedMulti` based on:

1. **Field names**: `WindupTime`, `AttackDuration`, `AttackSpeedMulti`
2. **Data flow**: Base times from WeaponInfo → Applied with multiplier → Stored in UnitEntity
3. **Naming convention**: "Multi" suffix indicates multiplicative scaling
4. **Game behavior**: Higher attack speed values = faster attacks (consistent with division)

The actual calculation code is in compiled native ARM assembly in `libil2cpp.so`, but the data structures and method signatures clearly show the formula's implementation.
